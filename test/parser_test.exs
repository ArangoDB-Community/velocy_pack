defmodule VelocyPackTest do
  use ExUnit.Case
  doctest VelocyPack

  import VelocyPack.Parser

  describe "parse" do
    test "empty array" do
      assert parse!(<<0x01>>) == []
    end

    test "empty object" do
      assert parse!(<<0x0a>>) == %{}
    end

    test "illegal" do
      assert parse!(<<0x17>>) == :illegal
    end

    test "nil" do
      assert parse!(<<0x18>>) == nil
    end

    test "boolean" do
      assert parse!(<<0x19>>) == false
      assert parse!(<<0x1a>>) == true
    end

    test "double" do
      assert parse!(<<0x1b, 0x66, 0x66, 0x66, 0x66, 0x66, 0xb6, 0x60, 0x40>>) == 133.7;
      assert parse!(<<0x1b, 0x66, 0x66, 0x66, 0x66, 0x66, 0xb6, 0x60, 0xc0>>) == -133.7;
    end

    test "date" do
      assert parse!(<<0x1c, 0, 83, 115, 5, -114, 0, 0, 0>>) == DateTime.from_unix(609976800000, :milliseconds)
    end    

    test "min/max key" do
      assert parse!(<<0x1e>>) == :min_key
      assert parse!(<<0x1f>>) == :max_key
    end

    test "int" do
      assert parse!(<<0x20, 0xff>>) == -1
      assert parse!(<<0x20, 0x7f>>) == 127
      assert parse!(<<0x20, 0x80>>) == -128
      assert parse!(<<0x21, 0xff, 0xff>>) == -1
      assert parse!(<<0x22, 0xff, 0xff, 0xff>>) == -1
      assert parse!(<<0x23, 0xff, 0xff, 0xff, 0xff>>) == -1
      assert parse!(<<0x24, 0xff, 0xff, 0xff, 0xff, 0xff>>) == -1
      assert parse!(<<0x25, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff>>) == -1
      assert parse!(<<0x26, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff>>) == -1
      assert parse!(<<0x27, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff>>) == -1
      assert parse!(<<0x27, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x7f>>) == 9223372036854775807
      assert parse!(<<0x28, 0xff>>) == 255
      assert parse!(<<0x29, 0xff, 0xff>>) == 65535
      assert parse!(<<0x2a, 0xff, 0xff, 0xff>>) == 16777215
      assert parse!(<<0x2b, 0xff, 0xff, 0xff, 0xff>>) == 4294967295
      assert parse!(<<0x2c, 0xff, 0xff, 0xff, 0xff, 0xff>>) == 1099511627775
      assert parse!(<<0x2d, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff>>) == 281474976710655
      assert parse!(<<0x2e, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff>>) == 72057594037927935
      assert parse!(<<0x2f, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff>>) == 18446744073709551615
    end
  end
end
